$.ajaxSetup({
    headers: {
        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
    }
});

function select(id, type) {
    if ($('#' + id).val() == -1) {
        Msg.inputText(id, type);
        return !0
    } else {
        Msg.removeInputText(id);
        return !1
    }
}

function emptyBox(id, type) {
    if ($('#' + id).val() == '') {
        Msg.inputText(id, type);
        return !0
    } else {
        Msg.removeInputText(id);
        return !1
    }
}

function chkEmail(id, type) {
    var e = $('#' + id).val();
    var regex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
    if (regex.test(e)) {
        return !0
    } else {
        return !1
    }
}

function validate(type = {}) {
    var chk = [];
    $.each(type, function(k, v) {
        switch (k) {
            case 'select':
                chk.push(select(v, k));
                break;
            case 'empty':
                chk.push(emptyBox(v, k));
                break;
            case 'email':
                chk.push(chkEmail(v, k));
                break
        }
    });
    return chk
}

function getSelectValues(main, sub, ph) {
    $('#' + main).on({
        'change': function() {
            var p = ph + '/' + this.value;
            $.ajax({
                url: p,
                method: 'get',
                dataType: 'json',
                success: function(data) {
                    console.log(data)
                }
            })
        }
    })
}
var handleDataTableButtons = function(id) {
    var i = '#' + id + 'Table';
    if ($(i).length) {
        $(i).DataTable({
            dom: "Bfrtip",
            buttons: [{
                extend: "copy",
                className: "btn-sm"
            }, {
                extend: "csv",
                className: "btn-sm"
            }, {
                extend: "excel",
                className: "btn-sm"
            }, {
                extend: "pdfHtml5",
                className: "btn-sm"
            }, {
                extend: "print",
                className: "btn-sm"
            }, ],
            responsive: !0
        })
    }
};
function validateSubject(valid){
    $('#validate_subject').val(valid);
}
Table = function() {
    return {
        init: function(id) {
            handleDataTableButtons(id)
        }
    }
}();
en=$('#base_url').val()+'/enquiry';
if (typeof(ID) != "undefined" && ID !== null) {
    CRUD = function() {
        var method = ['post', 'get', 'update', 'delete'];
        var eForm = ID + 'EForm',
            nForm = ID + 'Form',
            modal = '#' + ID + 'Modal';
        table = '#' + ID + 'Table';
        dmodal = '#' + ID + 'DModal';
        return {
            sendFormData: function(form, u, t) {
                var id = form.id.replace('Form', '');
                var fd = new FormData(form);
                switch (t) {
                    case 0:
                        ur = u;
                        Msg.txt('add', id);
                        break;
                    case 2:
                        ur = u + '/' + fd.get('sid');
                        fd.append('_method', 'patch');
                        Msg.txt('update', id);
                        break
                }
                $.ajax({
                    url: ur,
                    data: fd,
                    type: method[0],
                    processData: !1,
                    contentType: !1,
                    success: function(data) {
                        if (id == 'standard') {
                            if (data.std.length > 0) {
                                var d = [];
                                d.push('<option value = "-1">--Select--</option>');
                                $.each(data.std, function(k, v) {
                                    d.push('<option value = "' + v.std_id + '">' + v.std_name + '</option>')
                                });
                                $('#standard').html(d)
                            }
                            Msg.txt('success', 'standard')
                        }
                        if (id == 'admission' || id == 'admissionE') {
                            $('#studentA').val(data.s);
                            $('#otherBtn').show();
                            $('#finishBtn').show();
                            $('#saveBtn').hide()
                        }
                        if (id == 'relative') {
                            Msg.txt('success', 'relative');
                            if (data.s.length > 0) {
                                var d = [];
                                $('#relative-table-box').show();
                                $.each(data.s, function(k, v) {
                                    d.push('<tr><td>' + v.sr_full_name + '</td><td>' + v.sr_education + '</td><td>' + v.sr_age + '</td></tr>')
                                });
                                $('#relative-table tbody').html(d)
                            }
                        }
                        if (id == 'installment') {
                            Msg.txt('success', 'installment');
                            if (data.s.length > 0) {
                                var d = [];
                                $('#type').children('option:not(:first)').remove();
                                $("#type").append('<option value="Instalment '+data.installment_count+'">Instalment '+data.installment_count+'</option>');
                                $('#installment-box').show();
                                $.each(data.s, function(k, v) {
                                    d.push('<tr>' + '<td>' + v.install_type + '</td>' + '<td>' + v.install_amount + '</td>' + '<td>' + v.install_due_date.replace(' 00:00:00', '') + '</td>' + '<td>' + (v.install_pdc_no == null ? '-' : v.install_pdc_no) + '</td>' + '<td>' + v.install_pdc_date.replace(' 00:00:00', '') + '</td>' + '<td>' + (v.install_bank_name == null ? '-' : v.install_bank_name) + '</td>' + '</tr>')
                                });
                                $('#installment-table tbody').html(d)
                            }
                        }
                        if (id == 'previous') {
                            previous(data)
                        }
                        if (t == 2 && data != '') {
                            if (data.msg) {
                                Msg.txt(data.msg, id);
                                Msg.timer(function() {
                                    location.reload()
                                })
                            } else {
                                Msg.txt(data, id);
                                if (id == 'parentE' && data == 'successU') {
                                    location.href = en
                                }
                            }
                        } else if (id == "previous" || id == "relative" || id == "admission") {
                            Msg.txt(data.msg, id)
                        } else {
                            Msg.txt(data, id)
                        }
                        if ($('#' + ID + 'Modal').length) {
                            Msg.timer(function() {
                                $('#' + ID + 'Modal').modal('toggle')
                            })
                        }
                        if (id == 'subject') {
                            $('#subject-table').DataTable().ajax.reload()
                        }
                    },
                    error: function(xhr) {
                        Msg.txt('error', id)
                    }
                }).error(function(xhr) {
                    Msg.txt('error', id)
                })
            },
            formSubmission: function(u, t, val = {}, id = null) {
                url=$('#base_url').val();
                if (id != null) {
                    form = id + 'Form'
                } else {
                    form = (t == 2) ? eForm : nForm
                }
                $('#' + form).on({
                    'submit': function(e) {
                        e.preventDefault();
                        if($('#validate_subject').val()!=''&&(location.href==url+'/admission/create' || location.href==url+'/enquiry/create')){
                            if ($("input[type='checkbox'][name='subject[]']:checked").length <= 0){
                                $('#validate_subject').val('');
                                alert('Please Select atleast one subject.');
                                return false;
                            }
                             $('#validate_subject').val('');
                            // else{
                            //     return true;
                            // }   
                        }
                        if (!$.isEmptyObject(val)) {
                            if ($.inArray(!0, validate(val)) < 0) {
                                CRUD.sendFormData(this, u, t)
                            }
                        } else {
                            CRUD.sendFormData(this, u, t)
                        }
                        // if(location.href==url+'/enquiry/create')
                        // location.href=url+'/enquiry';
                 }   
                })
            },
            edit: function(u) {
                $('#' + nForm).attr('id', eForm);
                $.ajax({
                    url: u,
                    type: method[1],
                    success: function(data) {
                        $.each($('#' + eForm)[0], function(k, v) {
                            va = (v.name == 'sid') ? 'id' : v.name;
                            $(v).val(data[va])
                        });
                        $('#' + eForm + ' button[type="submit"]').html('UPDATE');
                        $(modal).modal('toggle');
                        CRUD.formSubmission(update, 2)
                    }
                })
            },
            add: function() {
                if ($('#' + eForm).length) {
                    $('#' + eForm)[0].reset();
                    $('#' + eForm).attr('id', nForm)
                }
                $('#' + nForm + ' button[type="submit"]').html('ADD');
                $(modal).modal('toggle');
                CRUD.formSubmission(store, 0)
            },
            delete: function(id) {
                $(dmodal).modal('toggle');
                $('#yes').attr('onclick', 'CRUD.confirmDelete(' + id + ');')
            },
            confirmDelete: function(id) {
                $.ajax({
                    url: deleteU + '/' + id,
                    type: method[3],
                    success: function(data) {
                        Msg.txt(data, ID + 'D');
                        Msg.timer(function() {
                            $(dmodal).modal('toggle')
                        });
                        $('#tr-' + id).remove()
                    }
                })
            }
        }
    }();
    Msg = function() {
        var msgDetail = {
            add: {
                msg: 'Adding, Please wait!!',
                class: 'warning'
            },
            update: {
                msg: 'Updating, Please wait!!',
                class: 'warning'
            },
            success: {
                msg: 'Successfully Added!!',
                class: 'success'
            },
            successU: {
                msg: 'Successfully Updated!!',
                class: 'success'
            },
            error: {
                msg: 'Something went wrong, Please try again!!',
                class: 'danger'
            },
            exist: {
                msg: 'Record Exist, Please try something new!!',
                class: 'warning'
            },
            same: {
                msg: 'Same as Previous, Please try something new!!',
                class: 'warning'
            },
            delete: {
                msg: 'Record Deleted Successfully!!',
                class: 'success'
            },
            input: {
                select: 'Please select option',
                empty: 'These field couldn\'t be Empty'
            }
        };
        var m = 1500;
        return {
            timer: function(data) {
                window.setTimeout(function() {
                    data()
                }, m)
            },
            txt: function(type, id = null) {
                var i = '#' + id + 'Msg';
                var f = '#' + id + 'Form';
                $(i).html('<div class = "alert alert-' + msgDetail[type].class + ' fade in">' + msgDetail[type].msg + '</div>');
                this.timer(function() {
                    if (type == 'success' || type == 'successU') {
                        $(f)[0].reset();
                        if (ID == 'enquiry' || id == "enquiryE" || ID == 'payment' || ID == 'invoice') {
                            location.href = en
                        }
                    }
                    $(i).html('')
                })
            },
            removeInputText: function(id) {
                $('#' + id).nextAll('span').remove()
            },
            inputText: function(id, type) {
                this.removeInputText(id);
                $('#' + id).after('<span style = "color: #db0c06;">' + msgDetail.input[type] + '</span>')
            }
        }
    }()
}

function previous(data) {
    var per = (parseInt(data.total) * 100) / (data.sub * 100);
    $('#previousYear').prop('readonly', 'true').val(per.toFixed(2));
    $('#myModal').modal('hide')
}
iCheck = function() {
    if ($.isFunction($.fn.iCheck)) {
        $('input[type="checkbox"].iCheck').iCheck({
            checkboxClass: 'icheckbox_minimal',
            radioClass: 'iradio_minimal',
            increaseArea: '20%'
        });
        var x;
        var colors = ["-green", "-red", "-yellow", "-blue", "-aero", "-orange", "-grey", "-pink", "-purple", "-white"];
        for (x = 0; x < colors.length; x++) {
            if (x == 0) {
                $('input.icheck-minimal').iCheck({
                    checkboxClass: 'icheckbox_minimal' + colors[x],
                    radioClass: 'iradio_minimal' + colors[x],
                    increaseArea: '20%'
                });
                $('input.skin-square').iCheck({
                    checkboxClass: 'icheckbox_square' + colors[x],
                    radioClass: 'iradio_square' + colors[x],
                    increaseArea: '20%'
                });
                $('input.skin-flat').iCheck({
                    checkboxClass: 'icheckbox_flat' + colors[x],
                    radioClass: 'iradio_flat' + colors[x],
                });
                $('input.skin-line').each(function() {
                    var self = $(this),
                        label = self.next(),
                        label_text = label.text();
                    label.remove();
                    self.iCheck({
                        checkboxClass: 'icheckbox_line' + colors[x],
                        radioClass: 'iradio_line' + colors[x],
                        insert: '<div class="icheck_line-icon"></div>' + label_text
                    })
                })
            }
            $('input.icheck-minimal' + colors[x]).iCheck({
                checkboxClass: 'icheckbox_minimal' + colors[x],
                radioClass: 'iradio_minimal' + colors[x],
                increaseArea: '20%'
            });
            $('input.skin-square' + colors[x]).iCheck({
                checkboxClass: 'icheckbox_square' + colors[x],
                radioClass: 'iradio_square' + colors[x],
                increaseArea: '20%'
            });
            $('input.skin-flat' + colors[x]).iCheck({
                checkboxClass: 'icheckbox_flat' + colors[x],
                radioClass: 'iradio_flat' + colors[x],
            });
            $('input.skin-line' + colors[x]).each(function() {
                var self = $(this),
                    label = self.next(),
                    label_text = label.text();
                label.remove();
                self.iCheck({
                    checkboxClass: 'icheckbox_line' + colors[x],
                    radioClass: 'iradio_line' + colors[x],
                    insert: '<div class="icheck_line-icon"></div>' + label_text
                })
            })
        }
    }
}
$('.datepicker').datepicker({
    dateFormat: 'dd-mm-yy'
});